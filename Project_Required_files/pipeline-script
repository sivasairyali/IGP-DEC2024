pipeline
{
      agent any
      stages
      {
             stage('code checkout')
             {
                   steps
                      { 
                            git 'https://github.com/sivasairyali/IGP-DEC2024.git'
                       }
              }
              stage('code compile')
              {
                   steps
                      { 
                            sh 'mvn compile'
                       }
              }
     	      stage('Test')
              {
                   steps
                      { 
                            sh 'mvn test'
                       }
              }
              stage('Package')
              {
                   steps
                      { 
                           sh 'mvn package'
                       }
              }

              stage('Build Docker Image')
              {
                   steps
                      { 
                           sh 'cp /var/lib/jenkins/workspace/$JOB_NAME/target/ABCtechnologies-1.0.war /var/lib/jenkins/workspace/abc_tech.war'
                           sh 'docker build -t abc_tech:latest .'
                           sh 'docker tag abc_tech:latest sivasairyali/abc_tech:latest'
                       }
              }
              
              stage('Push Docker Image')
              {
                    steps
                       {
                          withDockerRegistry([ credentialsId: "90fe7a84-4f32-449c-9034-429c1d5fef14", url: "" ])
                          {
                             sh 'docker push sivasairyali/abc_tech:latest'
                           }
                        }
               }
               
               stage('Deploy as container')
               { 
                      steps 
                       { 
                            
                            sh 'docker run -itd -P sivasairyali/abc_tech'
                       } 
               }
               
                stage('Deploy to kubernetes')
               { 
                      steps 
                       { 
                            sh 'whoami'
                            sh 'pwd'
                            sh 'kubectl apply -f app.yaml'
                       } 
               }
       }
}
